<!DOCTYPE html>
    <html>
    <head>
        <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
        <title>Game Object</title>
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
        
        <style>
.task-list-item { list-style-type: none; } .task-list-item-checkbox { margin-left: -20px; vertical-align: middle; }
</style>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        
        
    </head>
    <body>
        <hr>
<h2 id="layout-posttitle-%22Wwise-Game-Object%22subtitle-%22-%22Hello-World-Hello-Blog%22%22date-2019-03-29-120000author-%22AA%22header-img-%22imgpost-bg-2015jpg%22catalog-truetags--Wwise--Unreal">layout:     post
title:      &quot;Wwise Game Object&quot;
subtitle:   &quot; &quot;Hello World, Hello Blog&quot;&quot;
date:       2019-03-29 12:00:00
author:     &quot;AA&quot;
header-img: &quot;img/post-bg-2015.jpg&quot;
catalog: true
tags:
- Wwise
- Unreal</h2>
<h1 id="Game-Object">Game Object</h1>
<ul>
<li><font size =4> Q: 什么是Game Object？</font></li>
<li>A: Game Object没有固定的定义，在每款引擎甚至中间件内都有区别。不过总体意思相差不多，可以理解为对象，也就是需要实例化使用的具体类。</li>
<li>Unity中GameObject被简单抽象为需要放入场景实例化的“东西”。</li>
<li>UE4则具体化为AActor类及其子类，AActor类也是唯一能够在UWorld类中被Spawned的类型。所以简单来说所有可以被放到level map中的都属于Actor类(大多数情况下都不单是Actor类)。</li>
<li>这里有个容易混淆的地方，UE4拥有一个叫做UObject的类。这是一个比较底层的类别，也是AActor的基类。它拥有反射和序列化的一些属性，没有渲染和运动等组件。
<br> </br></li>
<li><font size =4>Q: Game Object在声音引擎中什么作用？</font></li>
<li>A: 对于游戏中每个发声体(Emitter),都需要注册给Wwise。最终每个声音事件的播放参数，在声音引擎中结算时都需要Emitter的各种数据,这里的Emitter就是Game Object。还有一类用来收听声源的收听体(Listener), 他们收集Emitter播放的声音以进行3D结算时需要的数据也得从注册的Game Object上获取。</li>
</ul>
<h1 id="Game-Object%E5%9C%A8Wwise%E4%B8%AD%E7%9A%84%E9%9B%86%E6%88%90">Game Object在Wwise中的集成</h1>
<ul>
<li><font size =4>Q: AkGameObjectID是什么?</font></li>
<li>A: 游戏引擎传给声音引擎表示game object的唯一标识符，无符号64位整型。</li>
</ul>
<pre><code class="language-cpp"><div><span class="hljs-comment">//AkTypes.h中有定义</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> __int64	AkUInt64;
</div></code></pre>
<ul>
<li><font size =4>Q: 怎么注册game object?</font></li>
</ul>
<pre><code class="language-cpp"><div> <span class="hljs-comment">//ID为uint64_t</span>
 <span class="hljs-keyword">const</span> AKGameObjectID car = <span class="hljs-number">1</span>;
 <span class="hljs-keyword">const</span> AKGameObjectID character = <span class="hljs-number">2</span>;
 (...)

 <span class="hljs-keyword">auto</span> result_car = AK::SoundEngine::RegisterGameObj(car);
 <span class="hljs-keyword">if</span>(result_car == AK_Success){...}
 
 <span class="hljs-comment">//双参数版本后面一个参数可以是内部object名称 const char*，这个name作用主要是在Debug版本中方便profile</span>
 <span class="hljs-keyword">auto</span> result_character = AK::SoundEngine::RegisterGameObj(character, <span class="hljs-string">"hero"</span>);
 <span class="hljs-keyword">if</span>(result_character == AK_Success){...}
  
 (...)
</div></code></pre>
<ul>
<li><font size =4>Q: 怎么注销game object?</font></li>
</ul>
<pre><code class="language-cpp"><div>  AK::SoundEngine::UnregisterGameObj(car);
  AK::SOundEngine::UnregisterGameObj(character);
  <span class="hljs-comment">//游戏结束注销所有对象</span>
  AK::SoundEngine::UnregisterAllGameObj();
</div></code></pre>
<ul>
<li><font size =4>Q：Unreal中怎么实现的？</font></li>
</ul>
<pre><code class="language-cpp"><div><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;AkAudioDevice.h&gt;</span></span>
<span class="hljs-comment">//注册</span>
<span class="hljs-keyword">namespace</span> FAkAudioDevice_Helpers
{
	<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">RegisterGameObject</span><span class="hljs-params">(AkGameObjectID in_gameObjId, <span class="hljs-keyword">const</span> FString&amp; Name)</span>
	</span>{
    <span class="hljs-comment">//Release版本中不需要监视对象名称，所以改为ID注册对象方式</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> AK_OPTIMIZED</span>
		AK::SoundEngine::RegisterGameObj(in_gameObjId);
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
		<span class="hljs-keyword">if</span> (Name.Len() &gt; <span class="hljs-number">0</span>)
		{
			AK::SoundEngine::RegisterGameObj(in_gameObjId, TCHAR_TO_ANSI(*Name));
		}
		<span class="hljs-keyword">else</span>
		{
			AK::SoundEngine::RegisterGameObj(in_gameObjId);
		}
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
	}
}


<span class="hljs-comment">//停用</span>
<span class="hljs-keyword">void</span> FAkAudioDevice::StopGameObject( UAkComponent * in_pComponent )
{
	AkGameObjectID gameObjId = DUMMY_GAMEOBJ;
	<span class="hljs-keyword">if</span> ( in_pComponent )
	{
		gameObjId = in_pComponent-&gt;GetAkGameObjectID();
	}
	<span class="hljs-keyword">if</span> ( m_bSoundEngineInitialized )
	{
		AK::SoundEngine::StopAll( gameObjId );
	}
}


<span class="hljs-comment">//注销函数没有上层包装，直接调用了API接口，几个地方引用到</span>
<span class="hljs-comment">//AkAudioDevice卸载函数</span>
<span class="hljs-keyword">void</span> FAkAudioDevice::Teardown()
{
  ...
  
  <span class="hljs-comment">//#define DUMMY_GAMEOBJ ((AkGameObjectID)0x2)</span>
  AK::SoundEngine::UnregisterGameObj( DUMMY_GAMEOBJ );
  
  ...
}

<span class="hljs-comment">//即播即销毁的声音对象</span>
AkPlayingID FAkAudioDevice::PostEventAtLocation(...)
{
  ...

  AK::SoundEngine::UnregisterGameObj( objId );

  ...
}

<span class="hljs-comment">//组件的注销</span>
<span class="hljs-keyword">void</span> FAkAudioDevice::UnregisterComponent(...)
{  
  <span class="hljs-comment">//见后文</span>
}
</div></code></pre>
<ul>
<li><font size =4>Q: 组件(AkComponent)怎么作为game object注册</font></li>
</ul>
<pre><code class="language-cpp"><div><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;AkAudioDevice.h&gt;</span></span>
<span class="hljs-comment">//注册</span>
<span class="hljs-keyword">void</span> FAkAudioDevice::RegisterComponent( UAkComponent * in_pComponent )
{
	<span class="hljs-keyword">if</span> (m_bSoundEngineInitialized &amp;&amp; in_pComponent)
	{
		<span class="hljs-comment">//检查是否使用AkComponent默认创建的Listener,并把AkComponent加入默认Emitters容器</span>
    <span class="hljs-keyword">if</span> (in_pComponent-&gt;UseDefaultListeners())
			m_defaultEmitters.Add(in_pComponent);

		<span class="hljs-comment">//设置AkComponent名字</span>
    FString WwiseGameObjectName = TEXT(<span class="hljs-string">""</span>);
		in_pComponent-&gt;GetAkGameObjectName(WwiseGameObjectName);
		
    <span class="hljs-comment">//取AkComponent的ID，使用之前实现的接口注册AkComponent给引擎</span>
		<span class="hljs-keyword">const</span> AkGameObjectID gameObjId = in_pComponent-&gt;GetAkGameObjectID();
		FAkAudioDevice_Helpers::RegisterGameObject(gameObjId, WwiseGameObjectName);

		<span class="hljs-comment">//如果使用空间组件的话，把AkComponent注册给SpatialAudioEmitter</span>
    <span class="hljs-keyword">if</span>(in_pComponent-&gt;bUseSpatialAudio)
			RegisterSpatialAudioEmitter(in_pComponent);
    
    <span class="hljs-comment">//AkComponent注册给CallbackManager</span>
		<span class="hljs-keyword">if</span> (CallbackManager != <span class="hljs-literal">nullptr</span>)
			CallbackManager-&gt;RegisterGameObject(gameObjId);
	}
}

  <span class="hljs-comment">//注销</span>
<span class="hljs-keyword">void</span> FAkAudioDevice::UnregisterComponent( UAkComponent * in_pComponent )
{
	<span class="hljs-keyword">if</span> (m_bSoundEngineInitialized &amp;&amp; in_pComponent)
	{
		<span class="hljs-comment">//在SoundEngine中注销</span>
    	<span class="hljs-keyword">const</span> AkGameObjectID gameObjId = in_pComponent-&gt;GetAkGameObjectID();
		AK::SoundEngine::UnregisterGameObj(gameObjId);
		<span class="hljs-comment">//在CallbackManager中注销</span>
    	<span class="hljs-keyword">if</span> (CallbackManager != <span class="hljs-literal">nullptr</span>)
		{
			CallbackManager-&gt;UnregisterGameObject(gameObjId);
		}
		<span class="hljs-comment">//在SpatialAudioEmitter中注销</span>
    	<span class="hljs-keyword">if</span>(in_pComponent-&gt;bUseSpatialAudio)
			UnregisterSpatialAudioEmitter(in_pComponent);
	}
	<span class="hljs-comment">//在listener中注销</span>
        <span class="hljs-keyword">if</span> (m_defaultListeners.Contains(in_pComponent))
	{
		RemoveDefaultListener(in_pComponent);
	}
	<span class="hljs-comment">//在defaultEmitter中注销</span>
        <span class="hljs-keyword">if</span> (in_pComponent-&gt;UseDefaultListeners())
	{
		m_defaultEmitters.Remove(in_pComponent);
	}
	check(!m_defaultListeners.Contains(in_pComponent) &amp;&amp; !m_defaultEmitters.Contains(in_pComponent));
	<span class="hljs-comment">//重置SpatialAudioListener</span>
         <span class="hljs-keyword">if</span> (m_SpatialAudioListener == in_pComponent)
		m_SpatialAudioListener = <span class="hljs-literal">nullptr</span>;
}
</div></code></pre>
<ul>
<li><font size =4>Q: 怎么通过组件(AkComponent)找到对应game object ID？</font></li>
</ul>
<pre><code class="language-cpp"><div><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;AkComponent.h&gt;</span></span>
<span class="hljs-comment">//调用这个类型转换</span>
AkGameObjectID UAkComponent::GetAkGameObjectID() <span class="hljs-keyword">const</span>
{
	<span class="hljs-keyword">return</span> (AkGameObjectID)<span class="hljs-keyword">this</span>;
}
</div></code></pre>
<h1 id="%E4%BE%9D%E8%B5%96Game-Object%E6%95%B0%E6%8D%AE%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8E%A5%E5%8F%A3">依赖Game Object数据的一些接口</h1>
<ul>
<li><font size =4>Q: 哪些声音数据结算依赖于game object？</font></li>
</ul>
<ol>
<li><font size =4>Audio Object相关联的所有偏置量(offset)</font></li>
</ol>
<pre><code class="language-cpp"><div>AKRESULT FAkAudioDevice::SetGameObjectOutputBusVolume(...)
{
	 ...
	f (m_bSoundEngineInitialized)
	
	<span class="hljs-keyword">const</span> AkGameObjectID emitterId = in_pEmitter ? i_pEmitter-&gt;GetAkGameObjectID() : DUMMY_GAMEOBJ;
	<span class="hljs-keyword">const</span> AkGameObjectID listenerId = in_pListener ? i_pListener-&gt;GetAkGameObjectID() : DUMMY_GAMEOBJ;
	eResult = AK::SoundEngine::SetGameObjectOutputBusVolume(mitterId, listenerId, in_fControlValue);
	
	eturn eResult;
}
</div></code></pre>
<ol start="2">
<li><font size =4>发声点位置和朝向</font></li>
</ol>
<pre><code class="language-cpp"><div><span class="hljs-comment">//和Event相关的接口</span>
<span class="hljs-keyword">auto</span> gameObjID = in_pComponent-&gt;GetAkGameObjectID();
AKRESULT AkAudioDevice::PostEvent(in_EventName, gameObjID, CeateCallbackPackage);

AKRESULT AK::SoundEngine::SeekOnEvent(TCHAR_TO_AK(*in_EventName),   i_pComponent-&gt;GetAkGameObjectID(), in_fPercent,   i_bSeekToNearestMarker, InPlayingID);

 <span class="hljs-comment">//和position相关接口</span>
AKRESULT FAkAudioDevice::SetPosition(...)
{
	...

	<span class="hljs-keyword">if</span>(in_akComponent-&gt;bUseSpatialAudio)
			<span class="hljs-keyword">return</span> AK::SpatialAudio::SetPosition(in_akComponent-&gt;GetAkGameObjectID(), in_SoundPosition);
	<span class="hljs-keyword">else</span>
		<span class="hljs-keyword">return</span> AK::SoundEngine::SetPosition(in_akComponent-&gt;GetAkGameObjectID(), in_SoundPosition);

	...
}

AKRESULT FAkAudioDevice::SetMultiplePositions(...)
{
	...

	<span class="hljs-keyword">return</span> AK::SoundEngine::SetMultiplePositions(n_pGameObjectAkComponent-&gt;GetAkGameObjectID(), aositions.GetData(), aPosiGetSoundE(in_eMult));

	...
}

<span class="hljs-keyword">void</span> FAkAudioDevice::SetListeners(...)
{
	...

	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span>&amp; Listener : in_listenerSet)
		pListenerIds[index++] = Listener-&gt;GetAkGameObjectID();

	AK::SoundEngine::SetListeners(in_pEmitter-&gt;GetAkGameObjectID(), pListenerIds, NumListeners);

	...
}

<span class="hljs-keyword">void</span> FAkAudioDevice::UpdateDefaultActiveListeners()
{
	...

	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> DefaultListenerIter = m_defaultListeners.CreateConstIterator(); DefaultListenerIter; ++DefaultListenerIter)
			pListenerIds[index++] = (*DefaultListenerIter)-&gt;GetAkGameObjectID();

	AK::SoundEngine::SetDefaultListeners(pListenerIds, NumDefaultListeners);

	...
}

<span class="hljs-comment">//和component相关接口</span>
<span class="hljs-keyword">void</span> FAkAudioDevice::RegisterComponent(...)
{
	...
	
	<span class="hljs-keyword">const</span> AkGameObjectID gameObjId = in_pComponent-&gt;GetAkGameObjectID();
		FAkAudioDevice_Helpers::RegisterGameObject(gameObjId, WwiseGameObjectName);

	...
}
</div></code></pre>
<p>3.<font size =4> Game Sync类数据(State, Switch,RTPC)</font></p>
<pre><code class="language-cpp"><div>AKRESULT FAkAudioDevice::SetSwitch(...)
{
	...

	<span class="hljs-keyword">auto</span> SwitchGroupID = AK::SoundEngine::GetIDFromString(TCHAR_TO_AK(in_pszSwitchGroup));
	<span class="hljs-keyword">auto</span> SwitchStateID = AK::SoundEngine::GetIDFromString(TCHAR_TO_AK(in_pszSwitchState));
	eResult = AK::SoundEngine::SetSwitch(SwitchGroupID, SwitchStateID, GameObjID);

	...
}

AKRESULT FAkAudioDevice::SetState(...)
{
	...

	<span class="hljs-keyword">auto</span> StateGroupID = AK::SoundEngine::GetIDFromString(TCHAR_TO_AK(in_pszStateGroup));
	<span class="hljs-keyword">auto</span> StateID = AK::SoundEngine::GetIDFromString(TCHAR_TO_AK(in_pszState));
	eResult = AK::SoundEngine::SetState(StateGroupID, StateID);

	...
}

AKRESULT FAkAudioDevice::SetRTPCValue(...)
{
	...

	AkGameObjectID GameObjID = AK_INVALID_GAME_OBJECT;
	<span class="hljs-keyword">if</span> ( in_pActor )
	{
		eResult = GetGameObjectID( in_pActor, GameObjID );
		<span class="hljs-keyword">if</span> ( eResult != AK_Success )
			<span class="hljs-keyword">return</span> eResult;
	}
	eResult = AK::SoundEngine::SetRTPCValue(TCHAR_TO_A(in_pszRtpcName), in_value, GameObjID,in_interpolationTimeMs );

	...
}
</div></code></pre>
<ol start="4">
<li><font size =4>空间类DSP效果器所需数据</font></li>
</ol>
<pre><code class="language-cpp"><div>AKRESULT FAkAudioDevice::SetAttenuationScalingFactor(...)
{
	...

	eResult = AK::SoundEngine::SetScalingFactor(AkComponent-&gt;GetAkGameObjectID(), ScalingFactor);

	...
}

AKRESULT FAkAudioDevice::SetAuxSends(...)
{
	...

 AK::SpatialAudio::SetEmitterAuxSendValues(n_akComponent-&gt;GetAkGameObjectID(), in_AuxSendValues.GetData(), n_AuxSendValues.Num());

    ...
}

<span class="hljs-keyword">void</span> FAkAudioDevice::RegisterSpatialAudioEmitter()
{
	...

	AK::SpatialAudio::RegisterEmitter(in_pComponent-&gt;GetAkGameObjectID(), settings);

	...
}
</div></code></pre>
<p>5.<font size =4> 声笼(Obstruction)和声障(Occlusion)计算所需数据</font></p>
<pre><code class="language-cpp"><div><span class="hljs-keyword">void</span> UAkComponent::UpdateOcclusionObstruction()
{ ObstructionService.UpdateObstructionOcclusion(Listeners, GetPosition(), GetOwner(), GetSpatialAudioRoom(), OcclusionCollisionChannel, OcclusionRefreshInterval); 
}

FAkAudioDevice::PostEvent(...)
{
	...

	in_pComponent-&gt;UpdateOcclusionObstruction();

	...
}
</div></code></pre>

    </body>
    </html>